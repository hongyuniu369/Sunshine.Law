
@{
    ViewBag.Title = "咨询答复";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var Cols = new Zephyr.Models.sys_roleMenuColumnMapService().GetCurrentUserMenuColumns();
}

@section scripts{
    <script src="/Content/js/viewModel/com.viewModel.search.js"></script>

    <script type="text/javascript">
        var data = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model));
        var viewModel = function(){ 
            var self = this;
            com.viewModel.search.apply(this,arguments);

            this.auditClick = function () {
                var row = self.grid.datagrid('getSelected');
                if (!row) return com.message('warning', self.resx.noneSelect);
                com.auditDialog(function (d) {
                    com.ajax({
                        type: 'POST',
                        url: self.urls.audit + row[self.idField],
                        data: JSON.stringify(d),
                        success: function () {
                            com.message('success', d.status == "passed" ? self.resx.auditPassed : self.resx.auditReject);
                            if(d.status == "passed")
                                setScore(row);
                            else
                                self.grid.datagrid('reload');
                        }
                    });
                });
            };

            this.dsBit = [{value:'true', text:'是'},{value:'false', text:'否'}];
            this.dsAudit = [{value:'passed', text:'通过'},{value:'reject', text:'未通过'}];
            
            this.isLawyer = false;//律师判断
            if(this.dataSource.extend && this.dataSource.extend.IsLawyer) 
                this.isLawyer = this.dataSource.extend.IsLawyer;
            this.isLawyerGrouper = false;//律师组长判断
            if(this.dataSource.extend && this.dataSource.extend.IsLawyerGrouper) 
                this.isLawyerGrouper = this.dataSource.extend.IsLawyerGrouper;

            //组长择优
            this.bestClick = function(){
                var row = self.grid.datagrid('getSelected');
                if (!row) return com.message('warning', '请选择一条信息');
                if(row.ApproveState != 'passed') return com.message('warning', '不能择优该答复');
                if(row.IsBestAnswer) return com.message('warning', '已是最佳答复答复');
                //数据提交
                com.message('confirm', '确定设为最佳答复？', function (b) {
                    if (b) {
                        com.ajax({
                            url: '/api/msg/advisoryanswer/best/' + row.AnswerCode,
                            success: function (d) {
                                com.message('success', '操作成功');
                                self.grid.datagrid('reload');
                            }
                        });
                    }
                });
            }
        }
        viewModel = new viewModel(data);
        ko.bindingViewModel(viewModel);

        var formatAudit = function (value,row) {return '<img src="/Content/images/' + ((value||'').toString()=="true" ? "checkmark.gif" : "checknomark.gif") + '"/>';};
    </script>
}

    @Html.RenderToolbar()

    <div class="container_12" style="position:relative;">
        <div class="grid_1 lbl">答复编号</div>
        <div class="grid_2 val"><input type="text" data-bind="value:form.AnswerCode" data-options="url:'/api/msg/advisoryanswer/getadvisoryanswercode'" class="z-txt easyui-autocomplete" /></div>
        <div class="grid_1 lbl">咨询编号</div>
        <div class="grid_2 val"><input type="text" data-bind="value:form.AdvisoryCode" data-options="url:'/api/msg/advisory/getadvisorycode'" class="z-txt easyui-autocomplete" /></div>
        <div class="grid_1 lbl" data-bind="style:{display:isLawyer?'none':''}">律师编号</div>
        <div class="grid_2 val" data-bind="style:{display:isLawyer?'none':''}"><input type="text" data-bind="value:form.LawyerCode" data-options="url:'/api/msg/lawyer/getlawyercode'" class="z-txt easyui-autocomplete" /></div>
        
        <div class="clear"></div>
        
        <div class="grid_1 lbl" data-bind="style:{display:isLawyerGrouper?'none':''}">审核状态</div>
        <div class="grid_2 val" data-bind="style:{display:isLawyerGrouper?'none':''}"><input type="text" data-bind="datasource:dsAudit,comboboxValue:form.ApproveState" data-options="showblank:true" class="z-txt easyui-combobox" /></div>
        <div class="grid_1 lbl">是否最佳</div>
        <div class="grid_2 val"><input type="text" data-bind="datasource:dsBit,comboboxValue:form.IsBestAnswer" data-options="showblank:true" class="z-txt easyui-combobox" /></div>
        <div class="grid_1 lbl">回复日期</div>
        <div class="grid_2 val"><input type="text" data-bind="value:form.AnswerDate" class="z-txt easyui-daterange" /></div>

        <div class="clear"></div>

        <div class="prefix_9" style="position:absolute;top:5px;height:0;">  
            <a id="a_search" href="#" class="buttonHuge button-blue" data-bind="click:searchClick" style="margin:0 15px;">查询</a> 
            <a id="a_reset"  href="#" class="buttonHuge button-blue" data-bind="click:clearClick">清空</a>
        </div>
    </div>
 
    <table data-bind="datagrid:grid">
            <thead>  
            <tr>  
                <th field="AnswerCode"    sortable="true" align="left"    width="90"     @Html.HideColumn(Cols,"AnswerCode") >答复编号</th>
                <th field="AdvisoryCode"    sortable="false" align="left"    width="90"     @Html.HideColumn(Cols,"AdvisoryCode") >咨询编号</th>
                <th field="LawyerCode"    sortable="false" align="left"    width="90"     @Html.HideColumn(Cols,"LawyerCode") >答复律师</th>
                <th field="AnswerContent"    sortable="false" align="left"    width="320"     @Html.HideColumn(Cols,"AnswerContent") >回复内容</th>
                <th field="IsSecret"    sortable="false" align="center"    width="45" formatter="com.formatCheckbox"    @Html.HideColumn(Cols,"IsSecret") >保密</th>
                <th field="AnswerDate"    sortable="true" align="left"    width="120" formatter="com.formatTime"    @Html.HideColumn(Cols,"AnswerDate") >答复日期</th>
                <th field="PraiseCount"    sortable="true" align="right"    width="50"     @Html.HideColumn(Cols,"PraiseCount") >点赞数</th>
                <th field="ApproveState"    sortable="false" align="center"    width="45" formatter="com.formatAudit"    @Html.HideColumn(Cols,"ApproveState") >审核</th>
                <th field="AdminScore"    sortable="true" align="right"    width="60"     @Html.HideColumn(Cols,"PraiseCount") >后台评分</th>
                <th field="IsBestAnswer"    sortable="false" align="center"    width="55" formatter="com.formatCheckbox"    @Html.HideColumn(Cols,"IsBestAnswer") >最佳回复</th>
            </tr>                            
        </thead>      
    </table>
 
@* 后台评分*@
<script type="text/html" id="score-template">

    <div class="container_16" style="width:90%;margin:5%;">  
        <div class="grid_2 lbl" style="font-weight: bold;color:#7e7789; font-size:160%; line-height:70px;">评分</div>  
        <div class="grid_14 val">
            <input type="text" class="kv-uni-star rating-loading" value="4" data-size="lg" title="">
        </div>
        <div class="clear"></div>
    </div> 
    <div style="text-align:center;">
        <a class="easyui-linkbutton" data-options="iconCls:'icon-ok'" data-bind="click:confirmClick" href="javascript:void(0)"  >确定</a>  
        <a class="easyui-linkbutton" data-options="iconCls:'icon-cancel'" data-bind="click:cancelClick" href="javascript:void(0)">取消</a> 
    </div>
</script>

 <script>
     //后台评分
     var setScore = function (row) {
         var adminScore = row.AdminScore?row.AdminScore:0;
         com.dialog({
             title: "后台评分",
             width: 600,
             html: "#score-template",
             onOpen: function(){
                 com.loadCss('/content/js/jquery-plugin/starrate/css/star-rating.min.css', parent.document);
                 parent.$.getScript("/content/js/jquery-plugin/starrate/js/star-rating.min.js").done(function() {
                     parent.$('.kv-uni-star').val(adminScore);
                     parent.$('.kv-uni-star').rating({
                         theme: 'krajee-uni',
                         filledStar: '&#x2605;',
                         emptyStar: '&#x2606;'
                     });
                     parent.$('.rating,.kv-uni-star').on(
                             'change', function () {
                                 adminScore = $(this).val();
                             });
                 });
             },
             viewModel: function (w) {
                 var self = this;

                 this.confirmClick = function () {
                     com.ajax({
                         url: '/api/msg/advisoryanswer/UpdateAdminScore/',
                         async: false,
                         data: ko.toJSON({
                             adminScore: adminScore,
                             lawyerCode: row.LawyerCode,
                             answerCode: row.AnswerCode
                         }),
                         success: function (row) {
                             com.message('success', '评分成功！');
                             self.cancelClick();
                         }
                     });
                 };
                 this.cancelClick = function () {
                     viewModel.grid.datagrid('reload');
                     w.dialog('close');
                 };
             }
         });
     };
</script>
